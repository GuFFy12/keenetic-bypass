# Установка и настройка обхода блокировок с использованием Zapret + Dnsmasq

## Требования

- Keenetic OS версии 4.0 или выше
- Установленный Entware

## Шаги установки

### 1. Установка необходимых пакетов через Entware

```bash
opkg install coreutils-sort curl git-http grep gzip ipset iptables kmod_ndms xtables-addons_legacy dnsmasq
```

### 2. Настройка Keenetic

- **Socks-прокси:** Включите и настройте Socks-прокси в веб-интерфейсе Keenetic.
- **HTTP DNS:** Настройте пользовательский HTTP DNS сервер.
- **Записи DNS:** Создайте записи DNS на адресе `192.168.1.1:5300` для доменов, доступ к которым блокируется без использования прокси.
  - Пример списка доменов:

  ```
  discord.media
  chatgpt.com
  openai.com
  oaiusercontent.com
  github.com
  githubusercontent.com
  ```

### 3. Установка скриптов и конфигурационных файлов

- Скачайте Zapret:

  ```bash
  cd /opt/
  git clone --depth=1 https://github.com/bol-van/zapret.git
  ```

- Скопируйте все файлы из репозитория в корень `/opt` с заменой существующих (вручную или через FTP/веб-интерфейс).
- Создайте символические ссылки на скрипты:

  ```bash
  ln -s /opt/zapret/init.d/sysv/zapret /opt/etc/init.d/S52zapret
  ln -s /opt/etc/dnsmasq_routing.sh /opt/etc/init.d/S53dnsmasq_routing
  ```

- Выполните первоначальную настройку:

  ```bash
  cd /opt/zapret/
  sh install_easy.sh
  ```

## Настройка конфигурационных файлов

### 1. Конфигурация zapret

- Откройте и отредактируйте файл конфигурации `zapret`, используя инструкцию из оригинального репозитория.
- Установите переменную `IFACE_WAN` на интерфейс `wan`, который использует внешний IP-адрес. Чтобы узнать его, выполните команду:

  ```bash
  ip addr
  ```

### 2. Конфигурация dnsmasq

- В параметре `server` укажите ваш внутренний HTTP DNS. Чтобы его получить, выполните команду:

  ```bash
  cat /tmp/ndnproxymain.stat
  ```

### 3. Конфигурация dnsmasq_routing

- **KILL_SWITCH** - если установлено в `1`, при отключении VPN или прокси трафик не будет направляться в сеть.
- **IPSET_TABLE_SAVE** - если установлено в `1`, таблица с IP-адресами будет сохранена при перезагрузке.
- **IPSET_TABLE** - задайте имя таблицы IPSET (например, `blocklist`).
- **IPSET_TABLE_TIMEOUT** - задайте тайм-аут для записей в таблице (например, `0` для неограниченного времени).
- **INTERFACE** - укажите интерфейс (например, `t2s_br0`).
- **INTERFACE_SUBNET** - укажите подсеть интерфейса (например, `172.20.12.1/32`).
- **MARK** - задайте маркер (например, `1001`).

## Дополнительные настройки

- Обратите внимание на другие возможные настройки в конфигурационных файлах, которые могут понадобиться для специфичных сценариев. Рассмотрите предоставление примеров этих сценариев для большей ясности.
